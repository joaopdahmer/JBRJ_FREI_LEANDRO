<!DOCTYPE html>
<html>
<head>
    <title>Trilha Frei Leandro</title>
    <meta charset="UTF-8">
    <style>
        /* Estilos gerais */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            overflow: hidden; /* Evita a barra de rolagem global */
        }
        /* Container principal */
        .container {
            display: flex;
            height: 100vh; /* Altura total da janela */
        }
        /* Estilos para o mapa */
        #map {
            width: 50%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
        }
        /* Estilos para a seção de narrativas */
        .narratives {
            width: 50%;
            margin-left: 50%; /* Para ficar ao lado do mapa */
            overflow-y: scroll;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        /* Estilos para cada framebox de narrativa */
        .plant-section {
            margin-bottom: 40px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 20px;
        }
        .plant-section img {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
        }
        .plant-section h2 {
            margin-top: 0;
        }
    </style>
    <!-- Inclua o CSS do Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

<div class="container">
    <!-- Div onde o mapa será renderizado -->
    <div id="map"></div>

    <!-- Seção das narrativas -->
    <div class="narratives">
        <!-- Cada narrativa possui um ID correspondente ao ID da planta -->
        <!-- ... (narrativas das plantas 1 a 10) ... -->
        <!-- As narrativas foram omitidas aqui para economizar espaço, mas devem ser incluídas conforme o código anterior -->
    </div>
</div>

<!-- Inclua os scripts do Leaflet -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Inclua o Leaflet Omnivore via unpkg -->
<script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

<script>
    // Inicializa o mapa
    var map = L.map('map', {
        zoomControl: false, // Remove os controles de zoom padrão
        maxZoom: 19 // Define o nível máximo de zoom
    }).setView([-22.9680, -43.2230], 17); // Zoom no arboreto

    // Adiciona a camada de tiles do OpenStreetMap com maxZoom definido
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // Carrega o arquivo GPX da trilha usando o Leaflet Omnivore
    var gpxLayer = omnivore.gpx('trilha_frei_leandro.gpx')
        .on('ready', function() {
            // Opcional: ajustar o mapa aos limites da trilha
            // map.fitBounds(this.getBounds());
        })
        .addTo(map);

    // Adiciona estilo à trilha GPX
    gpxLayer.setStyle({
        color: 'blue',
        weight: 5,
        opacity: 0.75,
        lineCap: 'round'
    });

    // Dados GeoJSON das plantas (todas as 10 plantas)
    var plantasGeoJSON = {
        "type": "FeatureCollection",
        "name": "plantas_frei_leandro",
        "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
        "features": [
            { "type": "Feature", "properties": { "id": 1 }, "geometry": { "type": "Point", "coordinates": [ -43.222145588873275, -22.969239816399224 ] } },
            // ... (demais plantas de 2 a 10) ...
        ]
    };

    // Variáveis globais para referência aos marcadores das plantas
    var plantMarkers = {};
    var currentPlantId = null; // Para rastrear qual planta está em foco

    // Adiciona os pontos das plantas ao mapa
    L.geoJSON(plantasGeoJSON, {
        pointToLayer: function(feature, latlng) {
            // Define o ícone personalizado para as plantas
            var plantIcon = L.icon({
                iconUrl: 'https://cloud.jbrj.gov.br/apps/files_sharing/publicpreview/PwkmGYHBiPLXqkQ?file=/&fileId=17944130&x=1446&y=760&a=true&etag=8baaf56e22ff20721c74c68b82a9eb73',
                iconSize: [32, 37],
                iconAnchor: [16, 37],
                popupAnchor: [0, -28]
            });
            var marker = L.marker(latlng, { icon: plantIcon });

            // Armazena o marcador em uma variável global para referência posterior
            plantMarkers[feature.properties.id] = marker;

            return marker;
        },
        onEachFeature: function(feature, layer) {
            // Cria popups com informações das plantas
            var plantNames = {
                1: 'Chá (Camellia sinensis)',
                // ... (demais plantas de 2 a 10) ...
            };

            var plantDescriptions = {
                1: 'Frei Leandro introduziu o chá no Brasil, promovendo seu cultivo local e contribuindo para a economia.',
                // ... (demais plantas de 2 a 10) ...
            };

            var popupContent = '<strong>' + plantNames[feature.properties.id] + '</strong><br>' +
                               plantDescriptions[feature.properties.id];
            layer.bindPopup(popupContent);
        }
    }).addTo(map);

    // Função para centralizar e dar zoom no marcador correspondente usando flyTo
    function focusOnPlant(plantId) {
        var marker = plantMarkers[plantId];
        if (marker) {
            map.flyTo(marker.getLatLng(), 19, { animate: true, duration: 1.5 }); // Zoom nível 19 (máximo)
            marker.openPopup();
        }
    }

    // Função para resetar o mapa ao estado padrão usando flyTo
    function resetMap() {
        map.flyTo([-22.9680, -43.2230], 17, { animate: true, duration: 1.5 }); // Zoom nível 17
        // Fecha todos os popups
        map.closePopup();
    }

    // Observa a rolagem das narrativas
    var options = {
        root: document.querySelector('.narratives'),
        rootMargin: '0px',
        threshold: 0.5 // Quando 50% do elemento estiver visível
    };

    var observer = new IntersectionObserver(function(entries, observer) {
        entries.forEach(function(entry) {
            var plantId = entry.target.id.split('-')[1];
            if (entry.isIntersecting) {
                // Quando a narrativa entra em foco
                currentPlantId = plantId;
                focusOnPlant(plantId);
            } else {
                // Quando a narrativa sai de foco
                if (currentPlantId === plantId) {
                    resetMap();
                    currentPlantId = null;
                }
            }
        });
    }, options);

    // Observa cada seção de planta
    document.querySelectorAll('.plant-section').forEach(function(section) {
        observer.observe(section);
    });

</script>

</body>
</html>
